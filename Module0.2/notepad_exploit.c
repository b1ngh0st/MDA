#include <windows.h>
#include <stdio.h>

int main()
{
    STARTUPINFOA si = {0};
    PROCESS_INFORMATION pi = {0};
    si.cb = sizeof(si);

    // 1) Launch Notepad suspended
    if (!CreateProcessA(
            "C:\\Windows\\System32\\notepad.exe",
            NULL, NULL, NULL, FALSE,
            CREATE_SUSPENDED,
            NULL, NULL,
            &si, &pi))
    {
        printf("[-] Failed to launch Notepad. Error: %d\n", GetLastError());
        return 1;
    }

    printf("[+] Notepad launched suspended. PID: %u\n", pi.dwProcessId);

    // 2) Resume Notepad immediately
    if (ResumeThread(pi.hThread) == (DWORD)-1)
    {
        printf("[-] Failed to resume Notepad. Error: %d\n", GetLastError());
        return 1;
    }
    printf("[+] Notepad resumed.\n");

    // 3) Allocate memory for DLL path in remote process
    const char dllPath[] = "C:\\Users\\b1n_g\\Desktop\\msgbox.dll"; // <-- full path to your DLL
    LPVOID remoteMem = VirtualAllocEx(
        pi.hProcess,
        NULL,
        sizeof(dllPath),
        MEM_COMMIT | MEM_RESERVE,
        PAGE_READWRITE
    );

    if (!remoteMem)
    {
        printf("[-] VirtualAllocEx failed. Error: %d\n", GetLastError());
        return 1;
    }

    // 4) Write DLL path into remote process
    if (!WriteProcessMemory(
            pi.hProcess,
            remoteMem,
            dllPath,
            sizeof(dllPath),
            NULL))
    {
        printf("[-] WriteProcessMemory failed. Error: %d\n", GetLastError());
        return 1;
    }

    // 5) Get address of LoadLibraryA
    HMODULE hKernel32 = GetModuleHandleA("kernel32.dll");
    LPVOID loadLibAddr = GetProcAddress(hKernel32, "LoadLibraryA");
    if (!loadLibAddr)
    {
        printf("[-] GetProcAddress(LoadLibraryA) failed. Error: %d\n", GetLastError());
        return 1;
    }

    // 6) Create remote thread to load the DLL
    HANDLE hThread = CreateRemoteThread(
        pi.hProcess,
        NULL,
        0,
        (LPTHREAD_START_ROUTINE)loadLibAddr,
        remoteMem,
        0,
        NULL
    );

    if (!hThread)
    {
        printf("[-] CreateRemoteThread failed. Error: %d\n", GetLastError());
        return 1;
    }

    // Wait for DLL to finish loading
    WaitForSingleObject(hThread, INFINITE);
    CloseHandle(hThread);

    printf("[+] DLL injected. MessageBox should appear now.\n");

    // 7) Cleanup
    VirtualFreeEx(pi.hProcess, remoteMem, 0, MEM_RELEASE);
    CloseHandle(pi.hThread);
    CloseHandle(pi.hProcess);

    printf("[+] Done.\n");
    return 0;
}
